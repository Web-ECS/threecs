<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>threecs | Examples: Physics Raycaster</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <script type="module">
      import {
        Object3D,
        Mesh,
        BoxBufferGeometry,
        SphereBufferGeometry,
        MeshBasicMaterial,
        Vector3,
        TextureLoader,
        ArrowHelper,
      } from "three";
      import {
        ActionType,
        createThreeWorld,
        addObject3DEntity,
        addComponent,
        addMapComponent,
        BindingType,
        FirstPersonCameraSystem,
        FirstPersonCameraActions,
        FirstPersonCameraYawTarget,
        FirstPersonCameraPitchTarget,
        loadPhysicsSystem,
        addPhysicsWorldComponent,
        addRigidBodyComponent,
        addPhysicsRaycasterComponent,
        DirectionalMovementSystem,
        DirectionalMovementActions,
        DirectionalMovementComponent,
        RigidBodyType,
        PhysicsColliderShape,
        defineSystem,
        defineQuery,
        setChildEntity,
        Object3DComponent,
        addMeshEntity,
      } from "../src/threecs";
      import crateTextureUrl from "./assets/crate.gif";

      async function main() {
        const PhysicsSystem = await loadPhysicsSystem();

        const { world, start } =
          createThreeWorld({
            pointerLock: true,
            systems: [
              FirstPersonCameraSystem,
              DirectionalMovementSystem,
              PhysicsSystem,
            ],
            actionMaps: [
              {
                id: "movement",
                actions: [
                  {
                    id: "look",
                    path: FirstPersonCameraActions.Look,
                    type: ActionType.Vector2,
                    bindings: [
                      {
                        type: BindingType.Axes,
                        x: "Mouse/movementX",
                        y: "Mouse/movementY",
                      },
                    ],
                  },
                  {
                    id: "move",
                    path: DirectionalMovementActions.Move,
                    type: ActionType.Vector2,
                    bindings: [
                      {
                        type: BindingType.DirectionalButtons,
                        up: "Keyboard/KeyW",
                        down: "Keyboard/KeyS",
                        left: "Keyboard/KeyA",
                        right: "Keyboard/KeyD",
                      },
                    ],
                  },
                ],
              },
            ],
          });

        const { sceneEid, cameraEid } = world;
        
        const camera = Object3DComponent.store.get(cameraEid);

        addPhysicsWorldComponent(world, sceneEid);

        const playerRigEid = addObject3DEntity(world, sceneEid);
        const playerRig = Object3DComponent.store.get(playerRigEid);
        
        addComponent(world, FirstPersonCameraYawTarget, playerRigEid);

        setChildEntity(playerRigEid, cameraEid);

        addComponent(world, FirstPersonCameraPitchTarget, cameraEid);
        addComponent(world, DirectionalMovementComponent, playerRigEid);
        addPhysicsRaycasterComponent(world, cameraEid, {
          withIntersection: true,
          debug: true,
        });

        playerRig.position.set(0, 0.5, 5);
        camera.position.set(0, 1.6, 0);

        const crateTexture = new TextureLoader().load(crateTextureUrl);
        const cubeEid = addMeshEntity(
          world,
          new BoxBufferGeometry(1, 1, 1),
          new MeshBasicMaterial({ map: crateTexture }),
          sceneEid,
        );
        const cube = Object3DComponent.store.get(cubeEid);
        cube.position.set(0.35, 2, 0.25);

        addRigidBodyComponent(world, cubeEid, {
          bodyType: RigidBodyType.Dynamic,
        });

        const sphereEid = addMeshEntity(
          world,
          new SphereBufferGeometry(1, 10, 10),
          new MeshBasicMaterial({ color: 0xff0000 }),
          sceneEid
        );
        const sphere = Object3DComponent.store.get(sphereEid);
        sphere.position.set(0, 0.25, -0.5);
        addRigidBodyComponent(world, sphereEid);

        const groundEid = addMeshEntity(
          world,
          new BoxBufferGeometry(10, 0.1, 10),
          new MeshBasicMaterial(),
          sceneEid,
        );
        const ground = Object3DComponent.store.get(groundEid);
        addRigidBodyComponent(world, groundEid);

        start();
      }

      main().catch(console.error);
    </script>
  </body>
</html>
