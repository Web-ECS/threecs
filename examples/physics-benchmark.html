<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>threecs | Examples: Rotating Cube</title>
    <link rel="stylesheet" href="./styles.css" />
    <style>
      .picker {
        position: fixed;
        z-index: 1;
        background-color: white;
        padding: 0 20px;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import wasmUrl from "ammo-wasm/builds/ammo-wasm.wasm?url";
      import {
        Mesh,
        BoxBufferGeometry,
        SphereBufferGeometry,
        MeshBasicMaterial,
        Vector3,
        TextureLoader,
      } from "three";
      import {
        createThreeWorld,
        addObject3DEntity,
        addMapComponent,
        addComponent,
        loadAmmoPhysicsSystem,
        loadRapierPhysicsSystem,
        PhysicsWorldComponent,
        PhysicsRigidBodyComponent,
        InstancedMeshRendererSystem,
        InstancedMeshRendererComponent,
        InstancedMeshRenderer,
        benchmark,
      } from "../src/threecs";
      import crateTextureUrl from "./assets/crate.gif";

      async function main() {
        let PhysicsSystem;

        const qs = new URLSearchParams(location.search);

        if (qs.has("rapier")) {
          document.getElementById("rapierLink").style.color = "blue";
          PhysicsSystem = await loadRapierPhysicsSystem();
        } else {
          document.getElementById("ammoLink").style.color = "blue";
          PhysicsSystem = await loadAmmoPhysicsSystem({ wasmUrl });
        }

        const { world, scene, sceneEid, camera, start } = createThreeWorld({
          systems: [benchmark(PhysicsSystem), InstancedMeshRendererSystem],
        });

        addMapComponent(world, PhysicsWorldComponent, sceneEid, {
          gravity: new Vector3(0, -6, 0),
        });

        camera.position.z = 5;
        camera.position.y = 3;
        camera.lookAt(0, 0, 0);

        const crateTexture = new TextureLoader().load(crateTextureUrl);
        const instancedMeshRenderer = new InstancedMeshRenderer(
          new BoxBufferGeometry(0.5, 0.5, 0.5),
          new MeshBasicMaterial({ map: crateTexture }),
          2500
        );
        const instancedMeshRendererEid = addObject3DEntity(
          world,
          instancedMeshRenderer,
          scene
        );
        addComponent(
          world,
          InstancedMeshRendererComponent,
          instancedMeshRendererEid
        );

        for (let i = 0; i < 2500; i++) {
          const cube = instancedMeshRenderer.createInstance();
          const cubeEid = addObject3DEntity(world, cube, scene);
          cube.position.y = Math.floor(i / 10) + 2;
          cube.position.x = (i % 10) - 5;
          cube.rotation.x = 0.35;
          cube.rotation.z = 0.25;
          addMapComponent(world, PhysicsRigidBodyComponent, cubeEid, {
            mass: 1,
          });
        }

        const sphere = new Mesh(
          new SphereBufferGeometry(1, 10, 10),
          new MeshBasicMaterial({ color: 0xff0000 })
        );
        const sphereEid = addObject3DEntity(world, sphere, scene);
        sphere.position.y = 0.25;
        sphere.position.z = -0.5;
        addMapComponent(world, PhysicsRigidBodyComponent, sphereEid, {
          mass: 0,
        });

        const ground = new Mesh(
          new BoxBufferGeometry(10, 0.1, 10),
          new MeshBasicMaterial()
        );
        const groundEid = addObject3DEntity(world, ground, scene);
        addMapComponent(world, PhysicsRigidBodyComponent, groundEid, {
          mass: 0,
        });

        start();
      }

      main().catch(console.error);
    </script>
    <div class="picker">
      <p>
        Physics Engine:
        <a id="ammoLink" href="?ammo">Ammo</a>
        <a id="rapierLink" href="?rapier">Rapier</a>
      </p>
      <p>See console for results.</p>
    </div>
  </body>
</html>
